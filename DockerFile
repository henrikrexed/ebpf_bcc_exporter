FROM ubuntu:20.04
RUN apt-get update
ENV TZ=Europe/Kiev
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
RUN apt-get -qq update && \
    apt-get -y install pbuilder aptitude git
RUN git clone https://github.com/iovisor/bcc.git

WORKDIR /bcc
RUN cp ./ /root/bcc
RUN ls scripts/
WORKDIR /root/bcc

RUN ls

RUN /usr/lib/pbuilder/pbuilder-satisfydepends && \
    ./scripts/build-deb.sh release


RUN \
  apt-get update -y && \
  DEBIAN_FRONTEND=noninteractive apt-get install -y python python3 python3-pip binutils libelf1 kmod  && \
    apt-get -y install python-pip && \
    pip install dnslib cachetools ; \
  pip3 install dnslib cachetools  && \
  dpkg -i /root/bcc/*.deb

RUN apt-get install --assume-yes --force-yes python  python3-pip
RUN apt-get install --assume-yes --force-yes bpfcc-tools linux-headers-$(uname -r)
RUN pip install prometheus_client
RUN mkdir prometheus_exporter
COPY library/ prometheus_exporter/library/
COPY script/ prometheus_exporter/script/
WORKDIR prometheus_exporter/script
RUN chmod +x ./run.sh
ENTRYPOINT [ "./run.sh"]
